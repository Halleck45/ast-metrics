{% extends "layout.html" %}

{% block title %}
    Explorer
{% endblock %}

{% block pageTitle %}
    AST Metrics - Explorer
{% endblock %}

{% block content %}
<h2 class="leading-none text-3xl font-bold text-gray-900 pb-4">Browse files</h2>
<div x-data="explorer()" x-init="init()" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
  
  <!-- Left: Tree, search and filters -->
  <div class="lg:col-span-1">

    <div class="bg-white rounded-xl border shadow-sm p-3">

      <!-- start: filters-->
      <div class="grid grid-cols-3 gap-4">
        <!-- start: search -->
         <div class="col-span-2">
          <label class="block text-xs font-medium text-gray-600">Search</label>
          <div class="flex justify-start items-center relative mb-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="absolute ml-2 text-gray-400 size-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <input x-model="filters.q" type="text" placeholder="Quick search..." class="pl-8 mt-1 w-full border rounded-lg px-2 py-1.5 text-sm" />
          </div>
        </div>
        <!-- end: search -->

        <!-- start: min -->
        <div>
          <label for="ipt-min-risks" class="block text-xs font-medium text-gray-600">Min risks</label>
          <input id="ipt-min-risks" " x-model.number="filters.minRisks" type="number" min="0" class="mt-1 w-full border rounded-lg px-2 py-1.5 text-sm" />
        </div>
        <!-- end: min -->
      </div>
      <!-- end: filters-->

      <div class="max-h-[65vh] overflow-auto pr-1">
        <!-- start: no result-->
        <template x-if="tree.length === 0">
          <div class="p-2 text-sm text-gray-500">No files match filters.</div>
        </template>
        <!-- end: no result-->

        <!-- start: tree -->
        <ul class="text-sm">
          <template x-for="root in tree" :key="root.name">
            <li class="mt-2">
              <div class="cursor-pointer font-semibold text-gray-800" @click="root.expanded = !root.expanded">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline text-gray-600 size-5 mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75 2.25 12l4.179 2.25m0-4.5 5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0 4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0-5.571 3-5.571-3" />
                </svg>
                <span x-text="root.name"></span>
              </div>
              <ul class="ml-4" x-show="root.expanded">
                <template x-for="dir in root.dirs" :key="dir.path">
                  <li class="my-1.5">
                    <div class="cursor-pointer font-medium text-gray-700" @click="dir.expanded = !dir.expanded">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="inline size-5 text-gray-600 mr-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                      </svg>
                      <span x-text="dir.name"></span>
                    </div>
                    <ul class="ml-6" x-show="dir.expanded">
                      <template x-for="f in dir.files" :key="f.path">
                        <li @click="select(f)" class="px-2 py-1 rounded-lg cursor-pointer my-1 hover:bg-gray-100 border border-transparent hover:border-gray-200" :class="selected && selected.path === f.path ? 'bg-blue-50 border-blue-200' : ''">
                          <div class=" items-center justify-between">
                            <div>
                              <span :class="riskColorByCount(nbRisksFor(f))" x-text="f.shortPath || f.path"></span>
                              <span class="block text-xs text-gray-500">(<span x-text="nbRisksFor(f)"></span> risks, risk score <span x-text="fileRiskScore(f).toFixed(2)"></span>)</span>
                            </div>
                          </div>
                        </li>
                      </template>
                    </ul>
                  </li>
                </template>
              </ul>
            </li>
          </template>
        </ul>
        <!-- end: tree -->
      </div>
    </div>
  </div>

  <!-- Right: Details panel -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-xl border shadow-sm p-4">
      <template x-if="!selected">
        <div class="text-gray-500">Select a file from the left-hand tree to view metrics, risks, and guidance.</div>
      </template>
      <template x-if="selected">
        <div>
          <!-- Header -->
          <div class="flex items-start justify-between">
            <div>
              <div class="text-lg font-semibold break-all" x-text="selected.path"></div>
              <div class="mt-2 flex flex-wrap items-center gap-2 text-xs">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border">Lang: <span class="ml-1 font-semibold" x-text="selected.programmingLanguage || '-' "></span></span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-amber-50 text-amber-700 border" :class="riskColorByCount(risks.length)">
                  Risks: <span class="ml-1 font-semibold" x-text="risks.length"></span>
                </span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-rose-50 text-rose-700 border">
                  Risk score: <span class="ml-1 font-semibold" x-text="fileRiskScore(selected).toFixed(2)"></span>
                </span>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border">
                  Commits (last year): <span class="ml-1 font-semibold" x-text="(selected.commits?.count)||0"></span>
                </span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button @click="openGlossary=true" class="text-xs inline-flex items-center gap-1 px-2 py-1 rounded-lg border hover:bg-gray-50">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-4"><path d="M11.25 3.042A8.25 8.25 0 1 0 19.46 11.25h-1.577a6.75 6.75 0 1 1-6.633-8.208z"/><path d="M12.75 6.75a.75.75 0 0 0-1.5 0v6a.75.75 0 0 0 1.5 0zM12 16.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5z"/></svg>
                Metric guide
              </button>
            </div>
          </div>

          <!-- Overview KPIs -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3 mt-4">
            <div class="rounded-xl border p-3">
              <div class="text-xs text-gray-500 flex items-center justify-between">
                Maintainability (worst class)
                <span :class="miBadgeClass(worstMI)"><span x-text="formatMI(worstMI)"></span></span>
              </div>
              <div class="mt-2">
                <div class="h-2 w-full rounded bg-gray-100 overflow-hidden">
                  <div class="h-2" :class="miBarClass(worstMI)" :style="`width: ${miPct(worstMI)}%`"></div>
                </div>
                <p class="mt-2 text-xs text-gray-600">Higher is better. Target ≥ 85.</p>
              </div>
            </div>
            <div class="rounded-xl border p-3">
              <div class="text-xs text-gray-500">Avg cyclomatic</div>
              <div class="mt-1 text-2xl font-semibold" x-text="avgCyclomatic.toFixed(2)"></div>
              <p class="mt-1 text-xs" :class="complexityTextClass(avgCyclomatic)">
                <span x-text="complexityBand(avgCyclomatic)"></span>
              </p>
            </div>
            <div class="rounded-xl border p-3">
              <div class="text-xs text-gray-500">Avg LCOM4</div>
              <div class="mt-1 text-2xl font-semibold" x-text="avgLCOM4Display"></div>
              <p class="mt-1 text-xs text-gray-600">Lower is better. 1 = cohesive.</p>
            </div>
            <div class="rounded-xl border p-3">
              <div class="text-xs text-gray-500">LLOC (file)</div>
              <div class="mt-1 text-2xl font-semibold" x-text="fileLLocDisplay"></div>
              <p class="mt-1 text-xs text-gray-600">Logical lines of code.</p>
            </div>
          </div>

          <!-- Panels -->
          <div class="grid gap-4 mt-4">
            <!-- Classes & Methods -->
            <div>
              <div class="rounded-xl border p-3">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Classes</div>
                  <span class="text-xs text-gray-500" x-text="classes.length + ' total'"></span>
                </div>
                <table class="w-full text-sm border rounded-md overflow-hidden mt-2">
                  <thead class="bg-gray-50">
                    <tr class="text-gray-700">
                      <th class="px-3 py-2 text-left">Name</th>
                      <th class="px-3 py-2 text-right">MI</th>
                      <th class="px-3 py-2 text-right">Instability</th>
                      <th class="px-3 py-2 text-right">LCOM4</th>
                      <th class="px-3 py-2 text-right">LLOC</th>
                      <th class="px-3 py-2 text-right">Bugs</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-if="classes.length === 0">
                      <tr><td colspan="6" class="px-3 py-3 text-gray-500">No classes in this file</td></tr>
                    </template>
                    <template x-for="c in classes" :key="c.name?.qualified || c.name?.short || Math.random()">
                      <tr class="odd:bg-white even:bg-gray-50 hover:bg-blue-50">
                        <td class="px-3 py-2" x-text="c.name ? c.name.qualified : '-' "></td>
                        <td class="px-3 py-2 text-right"><span :class="miBadgeClass(miRaw(c))" class="px-1.5 py-0.5 rounded text-xs" x-text="mi(c)"></span></td>
                        <td class="px-3 py-2 text-right" x-text="fmtNumber(c.stmts?.analyze?.coupling?.instability)"></td>
                        <td class="px-3 py-2 text-right" x-text="fmtNumber(c.stmts?.analyze?.classCohesion?.lcom4)"></td>
                        <td class="px-3 py-2 text-right" x-text="c.stmts?.analyze?.volume?.lloc ?? '-' "></td>
                        <td class="px-3 py-2 text-right" x-text="fmtFixed(c.stmts?.analyze?.volume?.halsteadBugs,4)"></td>
                      </tr>
                    </template>
                  </tbody>
                </table>

                <div class="font-semibold mt-4 mb-2">Methods</div>
                <table class="w-full text-sm border rounded-md overflow-hidden">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-2 py-1 text-left">Signature</th>
                      <th class="px-2 py-1 text-right">Cyclomatic</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y">
                    <template x-if="methods.length === 0">
                      <tr><td colspan="2" class="px-2 py-2 text-gray-500">No methods detected</td></tr>
                    </template>
                    <template x-for="m in methods" :key="m.name?.qualified || m.name?.short || Math.random()">
                      <tr class="odd:bg-white even:bg-gray-50">
                        <td class="px-2 py-1" x-text="m.name ? (m.name.describer || m.name.qualified || m.name.short) : '-' "></td>
                        <td class="px-2 py-1 text-right">
                          <span class="px-1.5 py-0.5 rounded text-xs" :class="complexityBadgeClass(m.stmts?.analyze?.complexity?.cyclomatic)" x-text="m.stmts?.analyze?.complexity?.cyclomatic ?? '-' "></span>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>

                <div class="mt-3 text-xs text-gray-600">
                  <span class="font-medium">Tip.</span> MI high is good. Cyclomatic low keeps code simpler. LCOM4 close to 1 means cohesive.
                </div>
              </div>
            </div>

            <!-- Risks -->
            <div>
              <div class="rounded-xl border p-3">
                <div class="flex items-center justify-between">
                  <div class="font-semibold">Detected risks (<span x-text="risks.length"></span>)</div>
                  <div class="flex items-center gap-2 text-xs">
                    <label class="inline-flex items-center gap-1"><input type="checkbox" class="rounded" x-model="filters.onlyHigh"/> High only</label>
                    <label class="inline-flex items-center gap-1"><input type="checkbox" class="rounded" x-model="filters.groupByCategory"/> Group</label>
                  </div>
                </div>

                <template x-if="risks.length === 0">
                  <div class="mt-2 text-sm text-gray-500">No risks detected by rules.</div>
                </template>

                <!-- Grouped view -->
                <template x-if="filters.groupByCategory && groupedRisksKeys.length">
                  <div class="mt-2 space-y-3">
                    <template x-for="cat in groupedRisksKeys" :key="cat">
                      <div>
                        <div class="text-xs uppercase tracking-wide text-gray-500 mb-1" x-text="cat || 'Uncategorized'"></div>
                        <div class="space-y-2">
                          <template x-for="r in groupedRisks[cat]">
                            <div class="border rounded-lg p-3 hover:bg-amber-50" :class="riskCardClass(r)">
                              <div class="flex items-start justify-between gap-3">
                                <div>
                                  <div class="flex items-center gap-2">
                                    <span class="text-sm font-medium" x-text="r.title"></span>
                                    <span class="px-1.5 py-0.5 rounded text-xs" :class="severityBadgeClass(r.severity)" x-text="severityLevel(r.severity)"></span>
                                  </div>
                                  <div class="text-sm text-gray-700 mt-1" x-text="r.details"></div>
                                  <template x-if="r.hint">
                                    <div class="text-xs text-gray-600 mt-1"><span class="font-medium">Fix:</span> <span x-text="r.hint"></span></div>
                                  </template>
                                </div>
                                <div class="text-right shrink-0">
                                  <div class="text-xs text-gray-500 text-center">Severity</div>
                                  <div class="mt-1 h-2 w-20 rounded bg-gray-100 overflow-hidden">
                                    <div class="h-2" :class="severityBarClass(r.severity)" :style="`width: ${severityPct(r.severity)}%`"></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>

                <!-- Flat list -->
                <template x-if="!filters.groupByCategory && risksSorted.length">
                  <div class="mt-2 space-y-2">
                    <template x-for="r in risksSorted">
                      <div class="border rounded-lg p-3 hover:bg-amber-50" :class="riskCardClass(r)">
                        <div class="flex items-start justify-between gap-3">
                          <div>
                            <div class="flex items-center gap-2">
                              <span class="text-sm font-medium" x-text="r.title"></span>
                              <span class="px-1.5 py-0.5 rounded text-xs" :class="severityBadgeClass(r.severity)" x-text="severityLevel(r.severity)"></span>
                            </div>
                            <div class="text-sm text-gray-700 mt-1" x-text="r.details"></div>
                            <template x-if="r.hint">
                              <div class="text-xs text-gray-600 mt-1"><span class="font-medium">Fix:</span> <span x-text="r.hint"></span></div>
                            </template>
                          </div>
                          <div class="text-right shrink-0">
                            <div class="text-xs text-gray-500">Severity</div>
                            <div class="h-2 w-20 rounded bg-gray-100 overflow-hidden">
                              <div class="h-2" :class="severityBarClass(r.severity)" :style="`width: ${severityPct(r.severity)}%`"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>

                <div class="mt-3 text-xs text-gray-600">
                  <span class="font-medium">How to read.</span> High severity first. Use hints to plan refactors.
                </div>
              </div>
            </div>
          </div>

          <!-- Glossary modal -->
          <div x-show="openGlossary" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/30" @click="openGlossary=false"></div>
            <div class="relative bg-white rounded-2xl shadow-xl border w-full max-w-2xl p-5">
              <div class="flex items-center justify-between mb-2">
                <div class="font-semibold">Metric guide</div>
                <button class="text-gray-500 hover:text-gray-700" @click="openGlossary=false">✕</button>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div>
                  <div class="font-medium">Maintainability Index (MI)</div>
                  <p class="text-gray-600">0–128. Higher is better. Aggregates complexity, size, and churn. Aim ≥ 85.</p>
                </div>
                <div>
                  <div class="font-medium">Cyclomatic complexity</div>
                  <p class="text-gray-600">Number of independent paths. ≤ 10 is usually OK. Keep low to ease testing.</p>
                </div>
                <div>
                  <div class="font-medium">LCOM4</div>
                  <p class="text-gray-600">Class cohesion. 1 means cohesive. Higher implies split responsibilities.</p>
                </div>
                <div>
                  <div class="font-medium">LLOC</div>
                  <p class="text-gray-600">Logical lines of code. Measures size. Prefer smaller units.</p>
                </div>
                <div>
                  <div class="font-medium">Instability</div>
                  <p class="text-gray-600">0–1. Outgoing deps ratio. Close to 0 for stable modules, close to 1 for volatile.</p>
                </div>
                <div>
                  <div class="font-medium">Halstead Bugs</div>
                  <p class="text-gray-600">Theoretical bugs density from Halstead volume. Use as a relative indicator.</p>
                </div>
              </div>
            </div>
          </div>

        </div>
      </template>
    </div>
  </div>
</div>

<!-- Data nodes provided as JSON for maintainability -->
<script id="files-data" type="application/json">{{filesJSON|safe}}</script>
<script id="risks-data" type="application/json">{{ risksJSON|safe }}</script>

{% endblock %}

{% block javascripts %}
<script defer>
  function explorer(){
    return {
      // state
      files: [],
      risksByPath: {},
      filters: { q: '', miMax: 128, minRisks: 0, onlyHigh: false, groupByCategory: true },
      tree: [],
      selected: null,
      risks: [],
      classes: [],
      methods: [],

      // derived KPIs
      worstMI: 0,
      avgCyclomatic: 0,
      avgLCOM4Display: '-',
      fileLLocDisplay: '-',

      // risks grouping
      groupedRisks: {},
      groupedRisksKeys: [],

      // ui
      openGlossary: false,

      init(){
        const parse = (id)=>{ try { return JSON.parse(document.getElementById(id)?.textContent||'null'); } catch(e){ return null; }};
        this.files = parse('files-data') || [];
        this.risksByPath = parse('risks-data') || {};
        this.$watch('filters', ()=> this.rebuild(), { deep: true });
        this.rebuild();
      },

      // helpers
      fmtFixed(v, n){ return (typeof v === 'number') ? v.toFixed(n) : '-'; },
      fmtNumber(v){ return (typeof v === 'number') ? (Number.isInteger(v)? v : v.toFixed(2)) : '-'; },
      fileRiskScore(f){ return f?.stmts?.analyze?.risk?.score || 0; },
      riskColorByCount(count){ return count>=5?'text-red-700':count>=3?'text-orange-700':count>=1?'text-amber-700':'text-green-700'; },
      fileMImax(f){
        let minMI = 128;
        const classes = f?.stmts?.stmtClass||[];
        if(!classes.length) return "-";
        for(const c of classes){
          const mi = c?.stmts?.analyze?.maintainability?.maintainabilityIndex;
          if (typeof mi === 'number' && mi < minMI) minMI = mi;
        }
        return minMI;
      },
      displayWorstMI(f){ const v = this.fileMImax(f); return Number.isFinite(v) ? `worst MI: ${v.toFixed(0)}` : ''; },
      nbRisksFor(f){ return (this.risksByPath[f.path]||[]).length; },
      matchesFilters(f){
        const q = (this.filters.q||'').toLowerCase();
        if (q && !f.path.toLowerCase().includes(q) && !(f.shortPath||'').toLowerCase().includes(q)) return false;
        const miVal = this.fileMImax(f);
        if (!isNaN(this.filters.miMax) && miVal > this.filters.miMax) return false;
        if (this.nbRisksFor(f) < (this.filters.minRisks||0)) return false;
        const currentLang = '{{ currentLanguage }}';
        if (currentLang && currentLang !== 'All' && f.programmingLanguage !== currentLang) return false;
        return true;
      },
      rebuild(){
        const filtered = this.files.filter(f => this.matchesFilters(f));
        const byDir = {};
        for (const f of filtered){
          const parts = (f.shortPath || f.path).split('/');
          let acc = '';
          for (let i=0;i<parts.length-1;i++){
            acc += (i?'/':'') + parts[i];
            if (!byDir[acc]) byDir[acc] = { files: [] };
          }
          const dir = parts.slice(0,-1).join('/');
          if (!byDir[dir]) byDir[dir] = { files: [] };
          byDir[dir].files.push(f);
        }
        const rootsMap = {};
        Object.keys(byDir).forEach(d => {
          const root = (d.split('/')[0]) || '/';
          if (!rootsMap[root]) rootsMap[root] = [];
          rootsMap[root].push(d);
        });
        this.tree = Object.keys(rootsMap).sort().map(root => ({
          name: root,
          expanded: true,
          dirs: rootsMap[root].sort().map(d => ({
            name: d,
            path: d,
            expanded: true,
            files: (byDir[d].files||[]).sort((a,b)=> a.path.localeCompare(b.path))
          }))
        }));
      },
      select(f){
        this.selected = f;
        this.risks = (this.risksByPath[f.path] || []).slice();
        const classes = f?.stmts?.stmtClass || [];
        this.classes = classes;
        this.methods = classes.flatMap(c => (c?.stmts?.stmtFunction)||[]);

        // KPIs
        this.worstMI = this.fileMImax(f) || 0;
        const cyclo = this.methods.map(m => m?.stmts?.analyze?.complexity?.cyclomatic).filter(x => typeof x === 'number');
        this.avgCyclomatic = cyclo.length ? (cyclo.reduce((a,b)=>a+b,0) / cyclo.length) : 0;
        const lcom = classes.map(c => c?.stmts?.analyze?.classCohesion?.lcom4).filter(x => typeof x === 'number');
        this.avgLCOM4Display = lcom.length ? (lcom.reduce((a,b)=>a+b,0)/lcom.length).toFixed(2) : '-';
        const vol = f?.stmts?.analyze?.volume;
        const fileLLOC = (vol && typeof vol.lloc === 'number') ? vol.lloc : null;
        if (fileLLOC !== null) this.fileLLocDisplay = String(fileLLOC); else {
          const classLL = classes.map(c => c?.stmts?.analyze?.volume?.lloc).filter(x => typeof x === 'number');
          this.fileLLocDisplay = classLL.length ? String(classLL.reduce((a,b)=>a+b,0)) : '-';
        }

        // Risks grouping
        this.computeGroupedRisks();
      },

      // MI formatting
      mi(c){ const v = this.miRaw(c); return typeof v==='number'? v.toFixed(2):'-'; },
      miRaw(c){ return c?.stmts?.analyze?.maintainability?.maintainabilityIndex; },
      miPct(v){ const x = Math.max(0, Math.min(128, Number(v)||0)); return (x/128*100).toFixed(0); },
      formatMI(v){ return Number.isFinite(v) ? v.toFixed(0) : '-'; },
      miBadgeClass(v){
        const val = Number(v)||0;
        if (val >= 85) return 'bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-xs';
        if (val >= 65) return 'bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded text-xs';
        return 'bg-rose-100 text-rose-700 px-1.5 py-0.5 rounded text-xs';
      },
      miBarClass(v){
        const val = Number(v)||0;
        if (val >= 85) return 'bg-green-500';
        if (val >= 65) return 'bg-amber-500';
        return 'bg-rose-500';
      },

      // Complexity formatting
      complexityBand(v){ if(v<=5) return 'Low'; if(v<=10) return 'Moderate'; if(v<=20) return 'High'; return 'Very high'; },
      complexityTextClass(v){ if(v<=5) return 'text-green-700'; if(v<=10) return 'text-amber-700'; if(v<=20) return 'text-orange-700'; return 'text-rose-700'; },
      complexityBadgeClass(v){ if(v<=5) return 'bg-green-100 text-green-700'; if(v<=10) return 'bg-amber-100 text-amber-700'; if(v<=20) return 'bg-orange-100 text-orange-700'; return 'bg-rose-100 text-rose-700'; },

      // Risks
      risksSorted(){
        const list = this.risks.slice().sort((a,b)=> (b.severity||0)-(a.severity||0));
        return this.filters.onlyHigh ? list.filter(r=> (r.severity||0) >= 0.75) : list;
      },
      computeGroupedRisks(){
        const byCat = {};
        const list = this.risksSorted();
        for(const r of list){
          const cat = r.category || r.rule || '';
          if(!byCat[cat]) byCat[cat] = [];
          byCat[cat].push(r);
        }
        this.groupedRisks = byCat;
        this.groupedRisksKeys = Object.keys(byCat).sort((a,b)=> a.localeCompare(b));
      },
      severityLevel(s){ const v = Number(s)||0; if(v>=0.9) return 'Critical'; if(v>=0.75) return 'High'; if(v>=0.5) return 'Medium'; if(v>0) return 'Low'; return 'Info'; },
      severityBadgeClass(s){ const v=Number(s)||0; if(v>=0.75) return 'bg-rose-100 text-rose-700'; if(v>=0.5) return 'bg-orange-100 text-orange-700'; if(v>0) return 'bg-amber-100 text-amber-700'; return 'bg-slate-100 text-slate-700'; },
      severityBarClass(s){ const v=Number(s)||0; if(v>=0.75) return 'bg-rose-500'; if(v>=0.5) return 'bg-orange-500'; if(v>0) return 'bg-amber-500'; return 'bg-slate-400'; },
      severityPct(s){ const v = Math.max(0, Math.min(1, Number(s)||0)); return (v*100).toFixed(0); },
      riskCardClass(r){ return (r.severity||0) >= 0.75 ? 'border-rose-200' : (r.severity||0) >= 0.5 ? 'border-orange-200' : 'border-amber-200'; },
    }
  }
</script>
{% endblock %}
